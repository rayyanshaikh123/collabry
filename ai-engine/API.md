# Collabry AI Engine - API Documentation

Complete API reference for the Collabry AI Engine.

## üìö Table of Contents

- [Authentication](#authentication)
- [Sessions API](#sessions-api)
- [Chat API](#chat-api)
- [Document Upload (RAG)](#document-upload-rag)
- [Q&A API](#qa-api)
- [Summarization API](#summarization-api)
- [Mind Map API](#mind-map-api)
- [Study Plan API](#study-plan-api)
- [Usage Analytics](#usage-analytics)
- [Health Check](#health-check)
- [Error Handling](#error-handling)
- [Rate Limiting](#rate-limiting)

---

## üîê Authentication

All endpoints (except `/health`) require JWT authentication.

### Headers

```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
```

### JWT Structure

```json
{
  "sub": "user-id-123",
  "email": "user@example.com",
  "exp": 1234567890,
  "iat": 1234567800
}
```

The JWT is generated by your authentication service and must be signed with the shared `JWT_SECRET`.

---

## üìù Sessions API

### Create Session

Create a new chat session.

**Endpoint**: `POST /ai/sessions`

**Request:**
```json
{
  "title": "Biology Study Session"
}
```

**Response:**
```json
{
  "id": "65abc123def456789",
  "user_id": "user-123",
  "title": "Biology Study Session",
  "last_message": "",
  "message_count": 0,
  "created_at": "2026-02-13T10:30:00Z",
  "updated_at": "2026-02-13T10:30:00Z"
}
```

### Get All Sessions

Get all sessions for the authenticated user.

**Endpoint**: `GET /ai/sessions`

**Response:**
```json
{
  "sessions": [
    {
      "id": "65abc123def456789",
      "user_id": "user-123",
      "title": "Biology Study Session",
      "last_message": "Explain photosynthesis",
      "message_count": 5,
      "created_at": "2026-02-13T10:30:00Z",
      "updated_at": "2026-02-13T11:00:00Z"
    }
  ],
  "total": 1,
  "limit_reached": false,
  "max_sessions": 50
}
```

### Get Session Messages

Get all messages for a specific session.

**Endpoint**: `GET /ai/sessions/{session_id}/messages`

**Response:**
```json
[
  {
    "role": "user",
    "content": "Explain photosynthesis",
    "timestamp": "2026-02-13T10:35:00Z",
    "user_id": "user-123"
  },
  {
    "role": "assistant",
    "content": "Photosynthesis is the process...",
    "timestamp": "2026-02-13T10:35:02Z"
  }
]
```

### Delete Session

Delete a session and all its messages.

**Endpoint**: `DELETE /ai/sessions/{session_id}`

**Response:**
```json
{
  "message": "Session deleted successfully"
}
```

### Clear Session Messages

Clear all messages from a session without deleting the session.

**Endpoint**: `DELETE /ai/sessions/{session_id}/messages`

**Response:**
```json
{
  "message": "Messages cleared successfully",
  "deleted_count": 10
}
```

---

## üí¨ Chat API

### Stream Chat Response

Send a message and receive a streaming response.

**Endpoint**: `POST /ai/sessions/{session_id}/chat/stream`

**Request:**
```json
{
  "message": "Explain photosynthesis in simple terms",
  "notebook_id": "biology-101",
  "source_ids": ["source1", "source2"],
  "sender_name": "John Doe",
  "is_collaborative": false,
  "use_rag": true
}
```

**Response** (Server-Sent Events):
```
event: token
data: {"type":"token","content":"Photo"}

event: token
data: {"type":"token","content":"synthesis"}

event: token
data: {"type":"token","content":" is"}

event: done
data: 
```

**Full Response Assembly:**
The client should accumulate all token events to build the complete response.

### Non-Streaming Chat

For non-streaming responses, use the legacy endpoint:

**Endpoint**: `POST /ai/chat`

**Request:**
```json
{
  "message": "Explain photosynthesis",
  "session_id": "session-123",
  "notebook_id": "biology-101",
  "stream": false
}
```

**Response:**
```json
{
  "response": "Photosynthesis is the process by which plants...",
  "session_id": "session-123",
  "usage": {
    "prompt_tokens": 50,
    "completion_tokens": 150,
    "total_tokens": 200
  }
}
```

---

## üì§ Document Upload (RAG)

Upload documents for RAG-based retrieval.

**Endpoint**: `POST /ai/upload`

**Request** (multipart/form-data):
```
file: [PDF/TXT/DOCX file]
session_id: "session-123"
notebook_id: "biology-101"
```

**cURL Example:**
```bash
curl -X POST http://localhost:8000/ai/upload \
  -H "Authorization: Bearer TOKEN" \
  -F "file=@biology_notes.pdf" \
  -F "session_id=session-123" \
  -F "notebook_id=biology-101"
```

**Response:**
```json
{
  "success": true,
  "message": "Document uploaded and indexed successfully",
  "document_id": "doc-123",
  "chunks_indexed": 15,
  "file_name": "biology_notes.pdf",
  "file_size": 102400
}
```

**Supported Formats:**
- PDF (.pdf)
- Text (.txt)
- Markdown (.md)
- Word Documents (.docx, .doc)

---

## ‚ùì Q&A API

Ask questions with RAG context.

**Endpoint**: `POST /ai/qa`

**Request:**
```json
{
  "question": "What is the role of chlorophyll in photosynthesis?",
  "session_id": "session-123",
  "notebook_id": "biology-101",
  "stream": false
}
```

**Response:**
```json
{
  "answer": "Chlorophyll is a green pigment that plays a crucial role in photosynthesis...",
  "sources": [
    {
      "content": "Chlorophyll absorbs light energy...",
      "source": "biology_notes.pdf",
      "page": 5
    }
  ],
  "confidence": 0.92
}
```

---

## üìÑ Summarization API

Summarize text or documents.

**Endpoint**: `POST /ai/summarize`

**Request:**
```json
{
  "text": "Long text to summarize...",
  "session_id": "session-123",
  "length": "medium",
  "format": "bullet_points"
}
```

**Parameters:**
- `length`: "short" | "medium" | "long"
- `format`: "paragraph" | "bullet_points" | "key_points"

**Response:**
```json
{
  "summary": "‚Ä¢ Main point 1\n‚Ä¢ Main point 2\n‚Ä¢ Main point 3",
  "word_count_original": 1500,
  "word_count_summary": 150,
  "compression_ratio": 0.1
}
```

---

## üó∫Ô∏è Mind Map API

Generate mind maps from topics.

**Endpoint**: `POST /ai/mindmap`

**Request:**
```json
{
  "topic": "Neural Networks",
  "session_id": "session-123",
  "depth": 3,
  "include_examples": true
}
```

**Response:**
```json
{
  "nodes": [
    {"id": "root", "label": "Neural Networks", "level": 0},
    {"id": "basics", "label": "Basic Concepts", "level": 1},
    {"id": "neurons", "label": "Artificial Neurons", "level": 2},
    {"id": "activation", "label": "Activation Functions", "level": 2}
  ],
  "edges": [
    {"from": "root", "to": "basics"},
    {"from": "basics", "to": "neurons"},
    {"from": "basics", "to": "activation"}
  ]
}
```

---

## üìö Study Plan API

Generate personalized study plans.

**Endpoint**: `POST /ai/generate-study-plan`

**Request:**
```json
{
  "topic": "Machine Learning",
  "duration_weeks": 8,
  "hours_per_week": 10,
  "current_level": "beginner",
  "goals": ["Build ML models", "Understand theory"],
  "session_id": "session-123"
}
```

**Response:**
```json
{
  "title": "8-Week Machine Learning Study Plan",
  "total_hours": 80,
  "weeks": [
    {
      "week": 1,
      "title": "Introduction to ML",
      "topics": ["What is ML?", "Types of learning"],
      "resources": ["Book: Introduction to ML", "Course: ML Basics"],
      "exercises": ["Exercise 1", "Exercise 2"],
      "hours": 10
    }
  ],
  "milestones": [
    {
      "week": 4,
      "title": "Mid-point Assessment",
      "description": "Build your first ML model"
    }
  ]
}
```

---

## üìä Usage Analytics

### Get User Usage

Get usage statistics for the authenticated user.

**Endpoint**: `GET /ai/usage/me`

**Response:**
```json
{
  "user_id": "user-123",
  "total_requests": 150,
  "total_tokens": 50000,
  "requests_today": 15,
  "tokens_today": 5000,
  "requests_this_month": 450,
  "tokens_this_month": 150000,
  "last_request": "2026-02-13T10:35:00Z"
}
```

### Get Global Statistics

Get global usage statistics (admin only).

**Endpoint**: `GET /ai/usage/global`

**Response:**
```json
{
  "total_users": 1250,
  "total_requests": 50000,
  "total_tokens": 15000000,
  "requests_today": 5000,
  "tokens_today": 1500000,
  "active_users_today": 450,
  "average_tokens_per_request": 300
}
```

---

## ‚ù§Ô∏è Health Check

Check if the service is healthy.

**Endpoint**: `GET /health`

**Response:**
```json
{
  "status": "healthy",
  "timestamp": "2026-02-13T10:30:00Z",
  "version": "1.0.0",
  "services": {
    "mongodb": "connected",
    "redis": "connected",
    "llm_provider": "available"
  }
}
```

---

## üö® Error Handling

All errors follow a consistent format:

```json
{
  "success": false,
  "message": "Error description",
  "error": {
    "code": "ERROR_CODE",
    "details": "Additional details"
  }
}
```

### Common Error Codes

| Status Code | Error Code | Description |
|------------|------------|-------------|
| 400 | `INVALID_REQUEST` | Missing or invalid parameters |
| 401 | `UNAUTHORIZED` | Invalid or missing JWT token |
| 403 | `FORBIDDEN` | Insufficient permissions |
| 404 | `NOT_FOUND` | Resource not found |
| 429 | `RATE_LIMIT_EXCEEDED` | Too many requests |
| 500 | `INTERNAL_ERROR` | Server error |
| 503 | `SERVICE_UNAVAILABLE` | External service unavailable |

### Example Error Response

```json
{
  "success": false,
  "message": "Session not found",
  "error": {
    "code": "NOT_FOUND",
    "details": "Session with ID 'session-999' does not exist"
  }
}
```

---

## ‚è±Ô∏è Rate Limiting

Rate limits are enforced per user/IP address.

### Default Limits

- **Per Minute**: 60 requests
- **Per Hour**: 1000 requests
- **Per Day**: 10000 requests

### Rate Limit Headers

All responses include rate limit information:

```http
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 45
X-RateLimit-Reset: 1676280000
```

### Rate Limit Exceeded Response

```json
{
  "success": false,
  "message": "Rate limit exceeded",
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "details": "You have exceeded the rate limit of 60 requests per minute",
    "retry_after": 30
  }
}
```

---

## üîÑ Webhook Support (Coming Soon)

Subscribe to events for real-time updates.

### Available Events

- `session.created`
- `session.updated`
- `message.created`
- `document.uploaded`
- `document.processed`
- `artifact.generated`

---

## üì¶ SDKs & Libraries

### Python SDK (Example)

```python
import requests

class CollabryAI:
    def __init__(self, api_key, base_url="http://localhost:8000"):
        self.api_key = api_key
        self.base_url = base_url
        
    def chat(self, message, session_id, notebook_id=None):
        response = requests.post(
            f"{self.base_url}/ai/sessions/{session_id}/chat/stream",
            headers={"Authorization": f"Bearer {self.api_key}"},
            json={
                "message": message,
                "notebook_id": notebook_id
            }
        )
        return response
        
    def create_session(self, title):
        response = requests.post(
            f"{self.base_url}/ai/sessions",
            headers={"Authorization": f"Bearer {self.api_key}"},
            json={"title": title}
        )
        return response.json()

# Usage
ai = CollabryAI(api_key="your-jwt-token")
session = ai.create_session("My Study Session")
chat_response = ai.chat("Explain photosynthesis", session["id"])
```

### JavaScript/TypeScript SDK (Example)

```typescript
class CollabryAI {
  constructor(private apiKey: string, private baseUrl: string = 'http://localhost:8000') {}
  
  async chat(message: string, sessionId: string, notebookId?: string) {
    const response = await fetch(`${this.baseUrl}/ai/sessions/${sessionId}/chat/stream`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ message, notebook_id: notebookId })
    });
    return response;
  }
  
  async createSession(title: string) {
    const response = await fetch(`${this.baseUrl}/ai/sessions`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ title })
    });
    return response.json();
  }
}

// Usage
const ai = new CollabryAI('your-jwt-token');
const session = await ai.createSession('My Study Session');
const chatResponse = await ai.chat('Explain photosynthesis', session.id);
```

---

## üìö Additional Resources

- [OpenAPI Specification](http://localhost:8000/openapi.json)
- [Interactive API Docs](http://localhost:8000/docs)
- [ReDoc Documentation](http://localhost:8000/redoc)
- [Postman Collection](./postman_collection.json) _(coming soon)_

---

**Last Updated**: February 2026
**API Version**: 1.0.0
