version: '3.8'

# ==========================================
# Collabry Multi-Service Docker Compose
# Local Development & Staging Environment
# ==========================================

services:
  # ============ APPLICATION SERVICES ============
  
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost/api}
        NEXT_PUBLIC_SOCKET_URL: ${NEXT_PUBLIC_SOCKET_URL:-http://localhost}
        NEXT_PUBLIC_AI_ENGINE_URL: ${NEXT_PUBLIC_AI_ENGINE_URL:-http://localhost/api/ai}
        NEXT_PUBLIC_RAZORPAY_KEY_ID: ${NEXT_PUBLIC_RAZORPAY_KEY_ID:-}
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID:-}
    container_name: collabry-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    networks:
      - frontend-network
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: collabry-backend
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - MONGODB_URI=${MONGODB_URI}
      - AI_ENGINE_URL=http://ai-engine:8000
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
      - REDIS_URL=redis://redis:6379
      - RAZORPAY_KEY_ID=${RAZORPAY_KEY_ID:-}
      - RAZORPAY_KEY_SECRET=${RAZORPAY_KEY_SECRET:-}
      - EMAIL_SERVICE=${EMAIL_SERVICE:-gmail}
      - EMAIL_USER=${EMAIL_USER:-}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
    volumes:
      - uploads:/app/uploads
      - invoices:/app/invoices
    networks:
      - frontend-network
      - backend-network
    depends_on:
      redis:
        condition: service_healthy
      ai-engine:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    stop_grace_period: 30s

  ai-engine:
    build:
      context: ./ai-engine
      dockerfile: Dockerfile
    container_name: collabry-ai-engine
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - MONGODB_URI=${MONGODB_URI}
      - MONGO_DB=${MONGO_DB:-collabry}
      - REDIS_URL=redis://redis:6379
      - BACKEND_URL=http://backend:5000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
      - JWT_SECRET_KEY=${JWT_ACCESS_SECRET}
      - FAISS_INDEX_PATH=/app/data/faiss_index
      - MAX_AGENT_ITERATIONS=${MAX_AGENT_ITERATIONS:-5}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://localhost:11434}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - USE_REDIS=${USE_REDIS:-true}
    volumes:
      - faiss-data:/app/data/faiss_index
      - jarvis-memory:/app/memory
      - ai-curricula:/app/data/curricula
      - ai-training:/app/data/training
    networks:
      - backend-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    stop_grace_period: 60s

  # ============ WORKER SERVICE ============
  
  backend-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.worker
    container_name: collabry-worker
    environment:
      - NODE_ENV=production
      - MONGODB_URI=${MONGODB_URI}
      - REDIS_URL=redis://redis:6379
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - EMAIL_SERVICE=${EMAIL_SERVICE:-gmail}
      - EMAIL_USER=${EMAIL_USER:-}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-}
    networks:
      - backend-network
    depends_on:
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  # ============ INFRASTRUCTURE SERVICES ============
  
  redis:
    image: redis:7-alpine
    container_name: collabry-redis
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 60 1
      --loglevel warning
    volumes:
      - redis-data:/data
    networks:
      - backend-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  # ============ OPTIONAL LOCAL SERVICES ============
  
  # Uncomment for local MongoDB (production uses MongoDB Atlas)
  # mongo:
  #   image: mongo:7
  #   container_name: collabry-mongo
  #   environment:
  #     MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-collabry}
  #     MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
  #     MONGO_INITDB_DATABASE: ${MONGO_DB:-collabry}
  #   volumes:
  #     - mongo-data:/data/db
  #   networks:
  #     - backend-network
  #   ports:
  #     - "27017:27017"
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3

  # Uncomment for local Ollama (alternative to OpenAI)
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: collabry-ollama
  #   volumes:
  #     - ollama-data:/root/.ollama
  #   networks:
  #     - backend-network
  #   ports:
  #     - "11434:11434"
  #   restart: unless-stopped

# ============ NETWORKS ============

networks:
  frontend-network:
    driver: bridge
    name: collabry-frontend-net
  
  backend-network:
    driver: bridge
    name: collabry-backend-net
    # Internal network - services cannot reach internet directly
    # Comment out 'internal: true' for development if AI services need internet
    # internal: true

# ============ VOLUMES ============

volumes:
  uploads:
    driver: local
    name: collabry-uploads
  
  invoices:
    driver: local
    name: collabry-invoices
  
  faiss-data:
    driver: local
    name: collabry-faiss
  
  jarvis-memory:
    driver: local
    name: collabry-memory
  
  ai-curricula:
    driver: local
    name: collabry-curricula
  
  ai-training:
    driver: local
    name: collabry-training
  
  redis-data:
    driver: local
    name: collabry-redis
  
  # Uncomment if using local MongoDB
  # mongo-data:
  #   driver: local
  #   name: collabry-mongo
  
  # Uncomment if using local Ollama
  # ollama-data:
  #   driver: local
  #   name: collabry-ollama
